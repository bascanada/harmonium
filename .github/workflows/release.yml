name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # ════════════════════════════════════════════════════════════════════
  # BUILD CLI & PLUGINS FOR MACOS
  # ════════════════════════════════════════════════════════════════════
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install Web Dependencies
        run: |
          cd web
          npm ci

      - name: Build Release (CLI + Plugins)
        run: make release

      - name: Generate Checksums
        run: |
          cd dist
          shasum -a 256 harmonium-cli-macos-universal.tar.gz > harmonium-cli-macos-universal.tar.gz.sha256
          shasum -a 256 harmonium-plugins-macos-universal.zip > harmonium-plugins-macos-universal.zip.sha256

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            dist/harmonium-cli-macos-universal.tar.gz
            dist/harmonium-cli-macos-universal.tar.gz.sha256
            dist/harmonium-plugins-macos-universal.zip
            dist/harmonium-plugins-macos-universal.zip.sha256

  # ════════════════════════════════════════════════════════════════════
  # CREATE GITHUB RELEASE
  # ════════════════════════════════════════════════════════════════════
  create-release:
    needs: build-macos
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      cli_sha256: ${{ steps.checksums.outputs.cli_sha256 }}
      plugins_sha256: ${{ steps.checksums.outputs.plugins_sha256 }}
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-builds
          path: dist

      - name: Read Checksums
        id: checksums
        run: |
          echo "cli_sha256=$(cat dist/harmonium-cli-macos-universal.tar.gz.sha256 | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "plugins_sha256=$(cat dist/harmonium-plugins-macos-universal.zip.sha256 | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Harmonium ${{ github.ref_name }}
          body: |
            ## Harmonium ${{ github.ref_name }}

            ### Installation

            **Via Homebrew (recommended):**
            ```bash
            brew tap bascanada/tap
            brew install harmonium              # CLI only
            brew install --cask harmonium-plugins  # VST3 + CLAP plugins
            ```

            **Manual Installation:**
            - **CLI:** Download `harmonium-cli-macos-universal.tar.gz`, extract, and move to `/usr/local/bin/`
            - **Plugins:** Download `harmonium-plugins-macos-universal.zip`, extract, and copy:
              - `harmonium.vst3` to `~/Library/Audio/Plug-Ins/VST3/`
              - `harmonium.clap` to `~/Library/Audio/Plug-Ins/CLAP/`

            ### Checksums (SHA256)
            ```
            ${{ steps.checksums.outputs.cli_sha256 }}  harmonium-cli-macos-universal.tar.gz
            ${{ steps.checksums.outputs.plugins_sha256 }}  harmonium-plugins-macos-universal.zip
            ```
          files: |
            dist/harmonium-cli-macos-universal.tar.gz
            dist/harmonium-plugins-macos-universal.zip
          draft: false
          prerelease: false

  # ════════════════════════════════════════════════════════════════════
  # UPDATE HOMEBREW TAP
  # ════════════════════════════════════════════════════════════════════
  update-homebrew-tap:
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - name: Update Homebrew Formula (CLI)
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          homebrew-tap: bascanada/homebrew-tap
          formula-name: harmonium
          formula-path: Formula/harmonium.rb
          download-url: https://github.com/bascanada/harmonium/releases/download/${{ github.ref_name }}/harmonium-cli-macos-universal.tar.gz
        env:
          COMMITTER_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}

      - name: Checkout Tap for Cask Update
        uses: actions/checkout@v4
        with:
          repository: bascanada/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Update Homebrew Cask (Plugins)
        run: |
          cd homebrew-tap
          mkdir -p Casks

          cat > Casks/harmonium-plugins.rb << 'EOF'
          cask "harmonium-plugins" do
            version "${{ github.ref_name }}"
            sha256 "${{ needs.create-release.outputs.plugins_sha256 }}"

            url "https://github.com/bascanada/harmonium/releases/download/v#{version}/harmonium-plugins-macos-universal.zip"
            name "Harmonium Plugins"
            desc "AI-powered generative music VST3/CLAP plugins"
            homepage "https://github.com/bascanada/harmonium"

            artifact "harmonium.vst3", target: "~/Library/Audio/Plug-Ins/VST3/harmonium.vst3"
            artifact "harmonium.clap", target: "~/Library/Audio/Plug-Ins/CLAP/harmonium.clap"

            # Remove quarantine to bypass Gatekeeper for unsigned plugins
            postflight do
              system_command "/usr/bin/xattr", args: ["-cr", "#{Dir.home}/Library/Audio/Plug-Ins/VST3/harmonium.vst3"]
              system_command "/usr/bin/xattr", args: ["-cr", "#{Dir.home}/Library/Audio/Plug-Ins/CLAP/harmonium.clap"]
            end

            uninstall delete: [
              "~/Library/Audio/Plug-Ins/VST3/harmonium.vst3",
              "~/Library/Audio/Plug-Ins/CLAP/harmonium.clap",
            ]

            caveats <<~EOS
              Restart your DAW to detect the new plugins.

              The plugins will be installed to:
                ~/Library/Audio/Plug-Ins/VST3/harmonium.vst3
                ~/Library/Audio/Plug-Ins/CLAP/harmonium.clap
            EOS
          end
          EOF

          # Remove 'v' prefix from version if present
          sed -i 's/version "v/version "/g' Casks/harmonium-plugins.rb

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Casks/harmonium-plugins.rb
          git commit -m "Update harmonium-plugins to ${{ github.ref_name }}" || echo "No changes to commit"
          git push
